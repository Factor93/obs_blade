name: Build and release FOSS version

on:
  push:
    branches: [foss]
    paths-ignore:
      - '**/README.md'

  # Allows you to run this workflow manually from the Actions tab
  # ONLY POSSIBLE IF IN *DEFAULT* BRANCH AS SET IN REPO
  workflow_dispatch:

jobs:
  build-release-foss:
    runs-on: ubuntu-latest
    steps:
      - name: Create new working dir
        run: |
          mkdir -p /tmp/build
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: foss
          submodules: recursive
          fetch-depth: 0
      - name: Move repo to new working dir
        run: |
          cp -Rp .
      - name: Set release version
        working-directory: /tmp/build
        run: |
          VER=$(cat pubspec.yaml | grep -o "version:[^:]*" | cut -f 2 -d ":" | cut -f 1 -d "+" | xargs)
          echo "APP_VERSION=$VER" >> $GITHUB_ENV
      # - name: Get Flutter SDK
      #   uses: subosito/flutter-action@v2
      #   with:
      #     channel: stable
      # - name: Get pubspec dependencies
      #   run: flutter pub get
      # - name: Build APK
      #   run: flutter build apk
      #--------------------------------------------------------
      # Make use of the pinned flutter version via git submodule
      # to ensure we are using a working flutter version for
      # this app / release
      #--------------------------------------------------------
      - name: Get pubspec dependencies
        working-directory: /tmp/build
        run: |
          pwd
          ls -la
          ./flutterw config --no-analytics
      - name: Get pubspec dependencies
        working-directory: /tmp/build
        run: ./flutterw pub get
      - name: Build APK
        working-directory: /tmp/build
        run: ./flutterw build apk
      - name: Rename APK
        working-directory: /tmp/build
        run: mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/obs-blade-foss-${{ env.APP_VERSION }}.apk
      - name: Create GitHub release and upload APK
        uses: softprops/action-gh-release@v1
        with:
          tag_name: foss-${{ env.APP_VERSION }}
          target_commitish: foss
          files: /tmp/build/build/app/outputs/flutter-apk/obs-blade-foss-${{ env.APP_VERSION }}.apk
